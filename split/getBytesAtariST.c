#include "querycsv.h"

static const struct codepointToByte atariBytes[159] = {
  {0x0006, 0x06}, {0x0007, 0x07}, {0x0009, 0x09},
  {0x000A, 0x0A}, {0x000C, 0x0C}, {0x000D, 0x0D},
  {0x000E, 0x0E}, {0x000F, 0x0F}, {0x0010, 0x10},
  {0x0011, 0x11}, {0x0012, 0x12}, {0x0013, 0x13},
  {0x0014, 0x14}, {0x0015, 0x15}, {0x0016, 0x16},
  {0x0017, 0x17}, {0x0018, 0x18}, {0x0019, 0x19},
  {0x001B, 0x1B}, {0x001C, 0x1C}, {0x001D, 0x1D},
  {0x001E, 0x01}, {0x001F, 0x1F}, {0x00A1, 0xAD},
  {0x00A2, 0x9B}, {0x00A3, 0x9C}, {0x00A5, 0x9D},
  {0x00A7, 0xDD}, {0x00A8, 0xB9}, {0x00A9, 0xBD},
  {0x00AA, 0xA6}, {0x00AB, 0xAE}, {0x00AC, 0xAA},
  {0x00AE, 0xBE}, {0x00AF, 0xFF}, {0x00B0, 0xF8},
  {0x00B1, 0xF1}, {0x00B2, 0xFD}, {0x00B3, 0xFE},
  {0x00B4, 0xBA}, {0x00B5, 0xE6}, {0x00B6, 0xBC},
  {0x00B7, 0xFA}, {0x00BA, 0xA7}, {0x00BB, 0xAF},
  {0x00BC, 0xAC}, {0x00BD, 0xAB}, {0x00BF, 0xA8},
  {0x00C0, 0xB6}, {0x00C3, 0xB7}, {0x00C4, 0x08},
  {0x00C5, 0x8F}, {0x00C6, 0x92}, {0x00C7, 0x80},
  {0x00C9, 0x90}, {0x00D1, 0xA5}, {0x00D5, 0xB8},
  {0x00D6, 0x99}, {0x00D8, 0xB2}, {0x00DC, 0x9A},
  {0x00DF, 0x09}, {0x00E0, 0x85}, {0x00E1, 0xA0},
  {0x00E2, 0x83}, {0x00E3, 0xB0}, {0x00E4, 0x84},
  {0x00E5, 0x86}, {0x00E6, 0x91}, {0x00E7, 0x87},
  {0x00E8, 0x8A}, {0x00E9, 0x82}, {0x00EA, 0x88},
  {0x00EB, 0x89}, {0x00EC, 0x8D}, {0x00ED, 0xA1},
  {0x00EE, 0x8C}, {0x00EF, 0x8B}, {0x00F1, 0xA4},
  {0x00F2, 0x95}, {0x00F3, 0xA2}, {0x00F4, 0x93},
  {0x00F5, 0xB1}, {0x00F6, 0x94}, {0x00F7, 0xF6},
  {0x00F8, 0xB3}, {0x00F9, 0x97}, {0x00FA, 0xA3},
  {0x00FB, 0x96}, {0x00FC, 0x81}, {0x00FF, 0x98},
  {0x0132, 0xC1}, {0x0133, 0xC0}, {0x0152, 0xB5},
  {0x0153, 0xB4}, {0x0192, 0x9F}, {0x0259, 0x1A},
  {0x0393, 0xE2}, {0x0398, 0xE9}, {0x03A3, 0xE4},
  {0x03A6, 0xE8}, {0x03A9, 0xEA}, {0x03B1, 0xE0},
  {0x03B2, 0xE1}, {0x03B4, 0xEB}, {0x03C0, 0xE3},
  {0x03C3, 0xE5}, {0x03C4, 0xE7}, {0x03D5, 0xED},
  {0x05D0, 0xC2}, {0x05D1, 0xC3}, {0x05D2, 0xC4},
  {0x05D3, 0xC5}, {0x05D4, 0xC6}, {0x05D5, 0xC7},
  {0x05D6, 0xC8}, {0x05D7, 0xC9}, {0x05D8, 0xCA},
  {0x05D9, 0xCB}, {0x05DA, 0xD9}, {0x05DB, 0xCC},
  {0x05DC, 0xCD}, {0x05DD, 0xDA}, {0x05DE, 0xCE},
  {0x05DF, 0xD8}, {0x05E0, 0xCF}, {0x05E1, 0xD0},
  {0x05E2, 0xD1}, {0x05E3, 0xDB}, {0x05E4, 0xD2},
  {0x05E5, 0xDC}, {0x05E6, 0xD3}, {0x05E7, 0xD4},
  {0x05E8, 0xD5}, {0x05E9, 0xD6}, {0x05EA, 0xD7},
  {0x2020, 0xBB}, {0x207F, 0xFC}, {0x2122, 0xBF},
  {0x21E6, 0x04}, {0x21E7, 0x01}, {0x21E8, 0x03},
  {0x21E9, 0x02}, {0x2208, 0xEE}, {0x2219, 0xF9},
  {0x221A, 0xFB}, {0x221E, 0xDF}, {0x2227, 0xDE},
  {0x2229, 0xEF}, {0x222E, 0xEC}, {0x2248, 0xF7},
  {0x2261, 0xF0}, {0x2264, 0xF3}, {0x2265, 0xF2},
  {0x2310, 0xA9}, {0x2320, 0xF4}, {0x2321, 0xF5},
  {0x266A, 0x0B}, {0x2713, 0x08}, {0x274E, 0x05}
};

void getBytesAtariST(
    long codepoint,
    char **bytes,
    int *byteLength
) {
  struct codepointToByte *lookup;

  if(byteLength != NULL && bytes != NULL) {
    *byteLength = 1;

    /* just cast the codepoint to a byte for basic ascii */
    if(codepoint > 0x1F && codepoint < 0x80) {
      *bytes = NULL;
      return;
    }

    if((lookup = (struct codepointToByte*)bsearch(
      (void *)&codepoint,
      (void *)atariBytes,
      159,
      sizeof(struct codepointToByte),
      compareCodepoints
    )) == NULL) {
      returnByte = 0x3f;  /* ascii question mark */
      *bytes = &returnByte;
      return;
    }

    returnByte = lookup->byte;  /* whatever the hash table lookup returned */
    *bytes = &returnByte;
  }
}
